MARenderMode={BASIC:0,WIREFRAME:1,LAMBERT:2,PHONG:3,EMISSIVE:4,POINT:5,SECTION:6},MARenderItem=function(){this.name=void 0,this.path=void 0,this.color=0,this.side=THREE.FrontSide,this.transparent=!1,this.opacity=1,this.mode=MARenderMode.PHONG,this.vertices=void 0,this.texture=void 0,this.visible=!0,this.clipplane=void 0},MARenderCameraState=function(){this.up=new THREE.Vector3(0,0,1),this.pos=new THREE.Vector3(0,0,0),this.target=new THREE.Vector3(0,0,0)},MARenderer=function(win,con){var self=this;this.type="MARenderer",Object.defineProperty(self,"version",{value:"1.2.4",writable:!1}),this.win=win,this.con=con,this.scene,this.ambLight,this.dirLight,this.pntLight,this.camera,this.cameraControls,this.renderer,this.animCount=0,this.pointSize=2,this.mousePos=new THREE.Vector2(0,0),this.pickOfs=0,this.nearPlane=1,this.farPlane=1e4,this.setCamOnLoad=!0,this.setHomeOnLoad=!0,this.useCameraControl=!0,this.conOffset=new THREE.Vector2(0,0),this.cameraPos=new THREE.Vector3(0,0,1e4),this.center=new THREE.Vector3(0,0,0),this.homeCameraView=new MARenderCameraState,this.saveCameraView=new MARenderCameraState,this.eventHandler=new THREE.EventDispatcher,this.noClipPlanes=Object.freeze([]),this.globalClipping=!1,this.globalClipPlanes=this.noClipPlanes,THREE.ImageUtils.crossOrigin="",this.init=function(){this.scene=new THREE.Scene,this.setConOffset(),this.camera=new THREE.PerspectiveCamera(25,this.con.clientWidth/this.con.clientHeight,this.nearPlane,this.farPlane),this.camera.updateProjectionMatrix(),this.cameraControls=this._makeCameraControls(),this.renderer=new THREE.WebGLRenderer({antialias:!0}),this.renderer.setSize(this.con.clientWidth,this.con.clientHeight),this.con.appendChild(this.renderer.domElement),this.scene.add(this.camera),this.ambLight=new THREE.AmbientLight(7829367),this.dirLight=new THREE.DirectionalLight(7829367),this.dirLight.position.set(0,0,1),this.pntLight=new THREE.PointLight(3355443,1,1e4),this.pntLight.position.set(0,.5,0),this.scene.add(this.pntLight),this.camera.add(this.ambLight),this.camera.add(this.dirLight),this.raycaster=new THREE.Raycaster,self.win.addEventListener("mousemove",self._trackMouse,!1),self.win.addEventListener("keypress",self._keyPressed,!1),self.win.addEventListener("resize",self._windowResize,!1)},this.setLocalClipping=function(state){self.renderer.localClippingEnabled=Boolean(state)},this.getLocalClipping=function(){return self.renderer.localClippingEnabled},this.setGlobalClipping=function(state){self.globalClipping=Boolean(state),self.globalClipping?self.renderer.clippingPlanes=this.globalClipPlanes:self.renderer.clippingPlanes=this.noClipPlanes,this.render()},this.setGlobalClipPlane=function(pln){Boolean(pln)&&pln instanceof THREE.Plane&&(self.globalClipPlanes=[pln],self.globalClipping&&(self.renderer.clippingPlanes=self.globalClipPlanes),this.render())},this.setPickOfs=function(ofs){var iofs,innerH;innerH=self.win.innerHeight,void 0!==ofs&&(iofs=parseInt(ofs,10),self.pickOfs=iofs/self.win.innerHeight*2)},this.addModel=function(gProp){var loader,itm=this._makeRenderItem(gProp);if(itm)switch(Number(itm.mode)){case MARenderMode.BASIC:case MARenderMode.WIREFRAME:case MARenderMode.LAMBERT:case MARenderMode.PHONG:case MARenderMode.EMISSIVE:case MARenderMode.POINT:if(itm.path){var ext=itm.path.split(".").pop();"stl"===ext?loader=new THREE.STLLoader:"vtk"===ext?loader=new THREE.VTKLoader:console.log("MARenderer.addModel() unknown file type: "+ext),loader.load(itm.path,function(geom){var mat=self._makeMaterial(itm);if(mat){switch(Number(itm.mode)){case MARenderMode.POINT:geom.colors.length>0&&(mat.vertexColors=THREE.VertexColors);var pcld=new THREE.PointCloud(geom,mat);pcld.name=itm.name,pcld.sortParticles=!0,self.scene.add(pcld);break;default:var mesh=new THREE.Mesh(geom,mat);mesh.name=itm.name,self.scene.add(mesh)}self.setCamOnLoad&&(self._computeCenter(),self.setCamera()),self.setHomeOnLoad&&self.setHome(),self.makeLive()}},function(){},function(){console.log("MARenderer.addModel() geometry load failed: "+itm.path)})}break;case MARenderMode.SECTION:itm.texture&&THREE.ImageUtils.loadTexture(itm.texture,THREE.UVMapping,function(tex){var geom=self.makeSectionGeometry(itm.vertices),mat=self._makeMaterial(itm);tex.flipY=!1,tex.minFilter=THREE.LinearFilter,tex.needsUpdate=!0,mat.map=tex;var pln=new THREE.Mesh(geom,mat);pln.name=itm.name,self.scene.add(pln),self.makeLive()},function(){console.log("MARenderer.addModel() texture load failed: "+itm.texture)})}},this.updateModel=function(gProp){if(gProp.name){var name=gProp.name,obj=this.scene.getObjectByName(name,!0);obj&&this._updateObj(obj,gProp)}this.render()},this.makeSectionGeometry=function(vertices){var geom=new THREE.Geometry;return vertices?geom.vertices=vertices.slice(0):geom.vertices=[new THREE.Vector3(0,0,0),new THREE.Vector3(1,0,0),new THREE.Vector3(1,1,0),new THREE.Vector3(0,1,0)],geom.faces=[new THREE.Face3(0,1,2),new THREE.Face3(2,3,0)],geom.faceVertexUvs[0]=[[new THREE.Vector2(0,0),new THREE.Vector2(1,0),new THREE.Vector2(1,1)],[new THREE.Vector2(1,1),new THREE.Vector2(0,1),new THREE.Vector2(0,0)]],geom.computeFaceNormals(),geom.computeBoundingBox(),geom},this.makePlaneFromAngles=function(pit,yaw,fxd,dst){var cp=Math.cos(pit),cy=Math.cos(yaw),sp=Math.sin(pit),sy=Math.sin(yaw),nrm=new THREE.Vector3(sp*cy,sp*sy,cp);dst+=fxd.x*nrm.x+fxd.y*nrm.y+fxd.z*nrm.z;var pln=new THREE.Plane(nrm,-dst);return pln},this.setConOffset=function(){for(var c=self.con,o=new THREE.Vector2(0,0);c;)o.x+=c.offsetLeft,o.y+=c.offsetTop,c=c.offsetParent;self.conOffset.copy(o)},this.makePlaneFromVertices=function(vtx){var pln;if(vtx&&vtx instanceof Array&&vtx.length>=3){var pln=new THREE.Plane;pln.setFromCoplanarPoints(vtx[0],vtx[1],vtx[2])}return pln},this.setCamera=function(cen,near,far,pos){cen||near||far||pos?(this.setCamOnLoad=!1,cen&&this.center.copy(cen),near&&(this.nearPlane=near),far&&(this.farPlane=far),pos&&this.cameraPos.copy(pos)):this._computeCenter(),this.camera.near=this.nearPlane,this.camera.far=this.farPlane,this.camera.updateProjectionMatrix(),this.camera.position.copy(this.cameraPos)},this.setHome=function(pos,up){this.cameraControls&&((pos||up)&&(this.setHomeOnLoad=!1),void 0===pos&&(pos=this.cameraControls.object.position.clone()),void 0===up&&(up=this.cameraControls.object.up.clone()),this.homeCameraView.up.copy(up),this.homeCameraView.pos.copy(pos),this.goHome())},this.goHome=function(){this.cameraControls&&(this.cameraControls.up0.copy(this.homeCameraView.up),this.cameraControls.position0.copy(this.homeCameraView.pos),this.cameraControls.target0.copy(this.center),this.cameraControls.reset())},this.removeModel=function(name){var obj=this.scene.getObjectByName(name,!0);obj&&(this.scene.remove(obj),obj.material&&obj.material.dispose(),obj.geometry&&obj.geometry.dispose(),this.render())},this.getChildren=function(){return this.scene.children},this.opacityIncrement=function(inc){for(var i=0,l=this.scene.children.length;l>i;i++){var child=this.scene.children[i];if(child&&"Mesh"===child.type&&child.material&&child.material.transparent&&void 0!=child.material.opacity){var op=child.material.opacity,tr=child.material.transparent;inc>0?.01>op?op=1/64:op*=2:op/=2,this._setMaterialOpacity(child.material,tr,op),child.material.needsUpdate=!0,this.render()}}},this.pointSizeSet=function(sz){void 0===sz&&(sz=this.pointSize);for(var i=0,l=this.scene.children.length;l>i;i++){var child=this.scene.children[i];child&&"PointCloud"===child.type&&child.material&&child.material.size&&(child.material.size=sz,child.material.needsUpdate=!0,this.render())}this.pointSize=sz},this.pointSizeIncrement=function(inc){for(var i=0,l=this.scene.children.length;l>i;i++){var child=this.scene.children[i];child&&"PointCloud"===child.type&&child.material&&child.material.size&&(child.material.size*=1+inc,child.material.size>99.9?child.material.size=99.9:child.material.size<.1&&(child.material.size=.1),child.material.needsUpdate=!0,this.render())}},this.render=function(){this.renderer.render(self.scene,self.camera)},this.setCameraControl=function(state){var newState=Boolean(state);newState!=this.useCameraControl&&(this.useCameraControl?this.cameraControls&&(this.saveCameraView.up.copy(this.cameraControls.object.up.clone()),this.saveCameraView.pos.copy(this.cameraControls.object.position.clone()),this.saveCameraView.target.copy(this.center),this.cameraControls.enabled=!1):(this.cameraControls.enabled=!0,this.cameraControls.up0.copy(this.saveCameraView.up),this.cameraControls.position0.copy(this.saveCameraView.pos),this.cameraControls.target0.copy(this.saveCameraView.target),this.cameraControls.reset()),this.useCameraControl=newState)},this.getCameraControl=function(){return this.useCameraControl},this.animate=function(){var aid=self.win.requestAnimationFrame(self.animate);self.useCameraControl&&self.cameraControls&&self.cameraControls.update(),self.render(),++self.animCount>400&&self.win.cancelAnimationFrame(aid)},this.makeLive=function(){var count=this.animCount;this.animCount=0,count>200&&this.animate()},this.addEventListener=function(type,listener){this.eventHandler.addEventListener(type,listener)},this.removeEventListener=function(type,listener){this.eventHandler.removeEventListener(type,listener)},this.getIIP3DBBVertices=function(url,vsz){var prmX=[0,1,1,0],prmY=[0,0,1,1],max=new THREE.Vector2,vtx=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3],req=new XMLHttpRequest;if(req.open("GET",url+"&OBJ=Wlz-true-voxel-size",!1),req.send(null),req.open("GET",url+"&OBJ=Max-size",!1),req.send(null),200===req.status){var rsp=req.responseText.split(":")[1].split(" ");max.x=rsp[0]-1,max.y=rsp[1]-1}for(var idx=0;4>idx;++idx)if(req.open("GET",url+"&PRL=-1,"+prmX[idx]*max.x+","+prmY[idx]*max.y+"&OBJ=Wlz-coordinate-3D",!1),req.send(null),200===req.status){var rsp=req.responseText.split(":")[1].split(" ");vtx[idx].set(rsp[0]*vsz.x,rsp[1]*vsz.y,rsp[2]*vsz.z)}return vtx},this._makeCameraControls=function(){var cc=new THREE.TrackballControls(this.camera,this.con);return cc.panSpeed=.3,cc.dynamicDampingFactor=.7,cc},this._setMaterialOpacity=function(mat,tr,op){mat&&tr&&(.01>op?mat.opacity=0:(op>1&&(op=1),.51>op?mat.depthWrite=!1:mat.depthWrite=!0,mat.opacity=op),this.render())},this._updateObj=function(obj,gProp){var itm=new MARenderItem;if(itm){if(gProp.color?itm.color=gProp.color:obj.material&&obj.material.color&&(itm.color=obj.material.color),void 0!==gProp.clipping)if(gProp.clipping instanceof THREE.Plane){var pln=(new THREE.Plane).copy(gProp.clipping);itm.clipping=[pln]}else itm.clipping=this.noClipPlanes;else obj.material&&(itm.clipping=obj.material.clippingPlanes);if(gProp.opacity?itm.opacity=gProp.opacity:obj.material&&obj.material.opacity&&(itm.opacity=obj.material.opacity),void 0!==gProp.transparent?itm.transparent=gProp.transparent:obj.material&&obj.material.transparent&&(itm.transparent=obj.material.transparent),void 0!==gProp.side?itm.side=gProp.side:obj.material&&(itm.side=obj.material.side),void 0!==gProp.visible?itm.visible=gProp.visible:obj.material&&(itm.visible=obj.material.visible),gProp.texture&&(itm.texture=gProp.texture.slice(0)),gProp.vertices&&(itm.vertices=gProp.vertices.slice(0)),gProp.mode){var mode=this._checkRenderMode(gProp.mode);mode&&(itm.mode=mode)}else"PointCloud"===obj.type?itm.mode=MARenderMode.POINT:obj.material&&obj.material.map&&(itm.mode=MARenderMode.SECTION)}switch(Number(itm.mode)){case MARenderMode.BASIC:case MARenderMode.WIREFRAME:case MARenderMode.LAMBERT:case MARenderMode.PHONG:case MARenderMode.EMISSIVE:case MARenderMode.POINT:var mat=this._makeMaterial(itm),oldmat=obj.material;obj.material=mat,oldmat&&oldmat.dispose();break;case MARenderMode.SECTION:obj.material.visible=itm.visible,obj.material.opacity=itm.opacity,itm.texture&&THREE.ImageUtils.loadTexture(itm.texture,THREE.UVMapping,function(tex){var oldgeom=obj.geometry,oldtex=obj.material.map,geom=self.makeSectionGeometry(itm.vertices);tex.flipY=!1,tex.minFilter=THREE.LinearFilter,tex.needsUpdate=!0,obj.material.map=tex,obj.geometry=geom,oldtex.dispose(),oldgeom.dispose(),self.makeLive()},function(){console.log("MARenderer.updateObj() texture load failed: "+itm.texture)})}},this._updateAllMesh=function(gProp){for(var i=0,l=this.scene.children.length;l>i;i++){var child=this.scene.children[i];child&&"Mesh"===child.type&&child.material&&!child.material.map&&(this._updateObj(child,gProp),this.render())}},this._makeRenderItem=function(gProp){var ok=!0,itm=new MARenderItem;for(var p in gProp)switch(p){case"name":case"path":case"side":itm[p]=gProp[p];break;case"color":case"opacity":case"pitch":case"yaw":case"dist":itm[p]=Number(gProp[p]);break;case"transparent":itm[p]=Boolean(gProp[p]);break;case"mode":var mode=this._checkRenderMode(gProp[p]);mode&&(itm[p]=mode);break;case"vertices":itm[p]=gProp[p].slice(0);break;case"texture":itm[p]=gProp[p].slice(0);break;case"visible":itm[p]=Boolean(gProp[p]);break;case"clipping":if(gProp[p]&&gProp[p]instanceof THREE.Plane){var pln=(new THREE.Plane).copy(gProp[p]);itm.clipping=[pln]}else itm.clipping=this.noClipPlanes;break;default:ok=!1,console.log("MARenderer._makeRenderItem() unknown property: "+p)}return ok||(itm=void 0),itm},this._checkRenderMode=function(gMode){var rMode=void 0;if(gMode)switch(Number(gMode)){case MARenderMode.BASIC:case MARenderMode.WIREFRAME:case MARenderMode.LAMBERT:case MARenderMode.PHONG:case MARenderMode.EMISSIVE:case MARenderMode.POINT:case MARenderMode.SECTION:rMode=gMode;break;default:console.log("MARenderer: Unknown mode: "+gMode)}return rMode},this._makeMaterial=function(itm){var mat,sProp={};switch(itm.mode){case MARenderMode.BASIC:sProp.color=itm.color,sProp.visible=itm.visible,sProp.clippingPlanes=itm.clipping,sProp.wiretrame=!1,mat=new THREE.MeshBasicMaterial(sProp);break;case MARenderMode.WIREFRAME:sProp.color=itm.color,sProp.opacity=itm.opacity,sProp.visible=itm.visible,sProp.clippingPlanes=itm.clipping,sProp.transparent=itm.transparent,sProp.wireframe=!0,sProp.wireframeLinewidth=1,mat=new THREE.MeshLambertMaterial(sProp);break;case MARenderMode.LAMBERT:sProp.color=itm.color,sProp.opacity=itm.opacity,sProp.visible=itm.visible,sProp.clippingPlanes=itm.clipping,sProp.transparent=itm.transparent,sProp.wireframe=!1,sProp.side=itm.side,mat=new THREE.MeshLambertMaterial(sProp);break;case MARenderMode.PHONG:sProp.color=itm.color,sProp.opacity=itm.opacity,sProp.visible=itm.visible,sProp.clippingPlanes=itm.clipping,sProp.transparent=itm.transparent,sProp.specular=1118481,sProp.wireframe=!1,sProp.side=itm.side,sProp.emissive=0,sProp.shininess=25,this._setMaterialOpacity(sProp,itm.transparent,itm.opacity),mat=new THREE.MeshPhongMaterial(sProp);break;case MARenderMode.EMISSIVE:sProp.color=itm.color,sProp.opacity=itm.opacity,sProp.visible=itm.visible,sProp.clippingPlanes=itm.clipping,sProp.transparent=itm.transparent,sProp.specular=7829367,sProp.wireframe=!1,sProp.emissive=itm.color,sProp.shininess=15,sProp.side=itm.side,mat=new THREE.MeshPhongMaterial(sProp);break;case MARenderMode.POINT:sProp.color=itm.color,sProp.visible=itm.visible,sProp.transparent=itm.transparent,sProp.clippingPlanes=itm.clipping,sProp.size=this.pointSize,sProp.blending=THREE.CustomBlending,sProp.blendSrc=THREE.DstAlphaFactor,sProp.blendDst=THREE.DstColorFactor,sProp.blendEquation=THREE.MaxEquation,sProp.alphaTest=.5,sProp.map=THREE.ImageUtils.loadTexture("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAQAAABuBnYAAAAAAmJLR0QA/4ePzL8AAAAJcEhZcwAACxMAAAsTAQCanBgAAAAHdElNRQfgAg8MNSkRqlGqAAAAVElEQVQI113NQQ0DIRBA0TcEFYQTSVWsAHRUWXUgoDY4bbAxPfS2X8D7ATk1nFhU8u0ysLPFp+Z0mTpe5CmaoYNuaMWj4thucNtOjZWNP+obK57bH17lGKmOV2FkAAAAAElFTkSuQmCC"),mat=new THREE.PointCloudMaterial(sProp);break;case MARenderMode.SECTION:sProp.color=itm.color,sProp.opacity=itm.opacity,sProp.transparent=itm.transparent,sProp.alphaTest=.2,sProp.visible=itm.visible,sProp.clippingPlanes=itm.clipping,sProp.wireframe=!1,sProp.side=THREE.DoubleSide,mat=new THREE.MeshBasicMaterial(sProp)}return mat},this._computeCenter=function(){for(var n=0,box=new THREE.Box3,i=0,l=this.scene.children.length;l>i;i++){var child=this.scene.children[i];if(child&&("Mesh"===child.type||"PointCloud"===child.type)){++n;var b=new THREE.Box3;b.setFromObject(child),b.min.add(child.position),b.max.add(child.position),1==n?box.copy(b):box.union(b)}}if(n>0){var d,min,max,dMax;min=box.min.x,max=box.max.x,dMax=box.max.x-box.min.x,d=box.max.y-box.min.y,d>dMax&&(dMax=d),min>box.min.y&&(min=box.min.y),max<box.max.y&&(max=box.max.y),d=box.max.z-box.min.z,d>dMax&&(dMax=d),min>box.min.z&&(min=box.min.z),max<box.max.z&&(max=box.max.z),this.center.copy(box.center()),this.nearPlane=.2>min?.1:.5*min,this.farPlane=1>max?10:10*max,this.cameraPos.set(0,0,this.center.z+4*dMax)}},this._testCode=function(){console.log("ren.version = "+self.version),console.log("cen = ("+self.center.x+", "+self.center.y+", "+self.center.z+")"),console.log("near = "+self.nearPlane),console.log("far = "+self.farPlane),console.log("pos = "+self.camera.position.x+", "+self.camera.position.y+", "+self.camera.position.z+")"),console.log("up = ("+self.camera.up.x+", "+self.camera.up.y+", "+self.camera.up.z+")"),console.log("ren.setCamera(new THREE.Vector3("+self.center.x+", "+self.center.y+", "+self.center.z+"), "+self.nearPlane+", "+self.farPlane+", new THREE.Vector3("+self.camera.position.x+", "+self.camera.position.y+", "+self.camera.position.z+"));\nren.setHome(new THREE.Vector3("+self.cameraControls.object.position.x+", "+self.cameraControls.object.position.y+", "+self.cameraControls.object.position.z+"), new THREE.Vector3("+self.camera.up.x+", "+self.camera.up.y+", "+self.camera.up.z+"));"),console.log("mousePos = ("+self.mousePos.x+", "+self.mousePos.y+")")},this._pick=function(){var pos=this.mousePos;pos.y=pos.y+self.pickOfs,self.raycaster.setFromCamera(pos,self.camera);var isct=self.raycaster.intersectObjects(self.scene.children,!1);isct.length>0&&self.eventHandler.dispatchEvent({type:"pick",hitlist:isct})},this._trackMouse=function(e){self.mousePos.x=(e.clientX-self.conOffset.x)/self.con.clientWidth*2-1,self.mousePos.y=2*-((e.clientY-self.conOffset.y)/self.con.clientHeight)+1,self.makeLive()},this._keyPressed=function(e){switch(e.charCode){case 33:self._testCode();break;case 60:self.opacityIncrement(-1);break;case 62:self.opacityIncrement(1);break;case 63:self._pick();break;case 67:self.setCamera(),self.goHome();break;case 72:self.setHome();break;case 104:self.goHome();break;case 112:self.pointSizeIncrement(.2);break;case 113:self.pointSizeIncrement(-.2);break;case 115:self._updateAllMesh({mode:MARenderMode.PHONG});break;case 119:self._updateAllMesh({mode:MARenderMode.WIREFRAME})}console.log("MARender: charCode = "+e.charCode)},this._windowResize=function(){self.setConOffset(),self.camera.aspect=self.con.clientWidth/self.con.clientHeight,self.camera.updateProjectionMatrix(),self.renderer.setSize(self.con.clientWidth,self.con.clientHeight),self.cameraControls&&self.cameraControls.handleResize(),self.makeLive()}};
